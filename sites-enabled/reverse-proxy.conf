# ===========================================
# Default server - routes based on IP address
# ===========================================

# Map destination IP to backend
map $server_addr $backend_host {
    # poli-worker-01-a
    130.192.166.200  poli-worker-01-a;
    130.192.166.201  poli-worker-01-a;
    130.192.166.202  poli-worker-01-a;
    130.192.166.203  poli-worker-01-a;
    
    # poli-worker-01-b
    130.192.166.204  poli-worker-01-b;
    130.192.166.205  poli-worker-01-b;
    130.192.166.206  poli-worker-01-b;
    130.192.166.207  poli-worker-01-b;
    
    # poli-worker-01-c
    130.192.166.208  poli-worker-01-c;
    130.192.166.209  poli-worker-01-c;
    130.192.166.210  poli-worker-01-c;
    130.192.166.211  poli-worker-01-c;
    
    # poli-worker-01-d
    130.192.166.212  poli-worker-01-d;
    130.192.166.213  poli-worker-01-d;
    130.192.166.214  poli-worker-01-d;
    130.192.166.215  poli-worker-01-d;
    
    # Default fallback
    default          poli-worker-01-a;
}

# ===========================================
# HTTP server - ACME challenge and redirect
# ===========================================
server {
    listen 80;
    server_name www0.idrago.org www1.idrago.org www2.idrago.org www3.idrago.org;

    # ACME challenge location for Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ===========================================
# Default HTTPS server
# ===========================================
server {
    listen 443 ssl default_server;
    server_name _;
    
    # Let's Encrypt certificate
    ssl_certificate /etc/letsencrypt/live/idrago.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/idrago.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    access_log /var/log/nginx/default-access.log detailed;
    error_log /var/log/nginx/default-error.log warn;
    
    location / {
        proxy_pass http://$backend_host;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
    }
}

# ===========================================
# idrago.org hosts
# ===========================================

# www0.idrago.org (130.192.166.202) -> poli-worker-01-a
server {
    listen 443 ssl;
    server_name www0.idrago.org;

    ssl_certificate /etc/letsencrypt/live/idrago.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/idrago.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    access_log /var/log/nginx/idrago.org/www0-access.log detailed;
    access_log /var/log/nginx/idrago.org/www0-access.json.log json_detailed;
    error_log /var/log/nginx/idrago.org/www0-error.log warn;

    location / {
        proxy_pass http://poli-worker-01-a;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
    }
}

# www1.idrago.org (130.192.166.206) -> poli-worker-01-b
server {
    listen 443 ssl;
    server_name www1.idrago.org;

    ssl_certificate /etc/letsencrypt/live/idrago.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/idrago.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    access_log /var/log/nginx/idrago.org/www1-access.log detailed;
    access_log /var/log/nginx/idrago.org/www1-access.json.log json_detailed;
    error_log /var/log/nginx/idrago.org/www1-error.log warn;

    location / {
        proxy_pass http://poli-worker-01-b;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
    }
}

# www2.idrago.org (130.192.166.210) -> poli-worker-01-c
server {
    listen 443 ssl;
    server_name www2.idrago.org;

    ssl_certificate /etc/letsencrypt/live/idrago.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/idrago.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    access_log /var/log/nginx/idrago.org/www2-access.log detailed;
    access_log /var/log/nginx/idrago.org/www2-access.json.log json_detailed;
    error_log /var/log/nginx/idrago.org/www2-error.log warn;

    location / {
        proxy_pass http://poli-worker-01-c;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
    }
}

# www3.idrago.org (130.192.166.214) -> poli-worker-01-d
server {
    listen 443 ssl;
    server_name www3.idrago.org;

    ssl_certificate /etc/letsencrypt/live/idrago.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/idrago.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    access_log /var/log/nginx/idrago.org/www3-access.log detailed;
    access_log /var/log/nginx/idrago.org/www3-access.json.log json_detailed;
    error_log /var/log/nginx/idrago.org/www3-error.log warn;

    location / {
        proxy_pass http://poli-worker-01-d;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
    }
}